<!DOCTYPE html>
<html lang="en" ng-app="radiowiziApp">
<head>
    <title>{%  block title %}{% endblock %}Radio Wizi - Instant classics</title>
    <meta name="description" content="Radio Wizi.">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block stylesheets %}{% endblock %}
    <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}"/>

    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/main.min.css">

</head>
<body>
<a href="https://github.com/borisson/hipchat-youtube-queue"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    <div class="page">
        <h1 class="header__logo"><a href="" class="ir">Radio Wizi</a></h1>
        <div ng-view></div>
        {#{% block body %}{% endblock %}#}
    </div>
{% block javascripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-resource.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>

    <script src="/js/src/libs/angular-youtube-embed.min.js"></script>
    <script src="/js/src/app.js"></script>
    <script src="/js/src/controllers.js"></script>
    <script src="/js/src/services.js"></script>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="text/javascript">
        var player;
        var done = false;
        var currenttimeint = $('.player__title').data('video-skip');
        var currenttime = '00:00:00';
        var currentpct = 0;
        var totaltime = 0;
        var watchId;
        var notificationShown = false;

        $(document).ready(function() {
            var $timeDuration = $('.player__time-duration');
            totaltime = $timeDuration.text();
            $timeDuration.text($timeDuration.text().toHHMMSS());
        });

        /**
         * Start current player timer.
         */
        function startWatch(){
            watchId = setInterval( function(){
                if(typeof player.getCurrentTime === 'function' && !isNaN(player.getCurrentTime())) {
                    currenttimeint = Number(player.getCurrentTime());
                    currenttime = String(currenttimeint).toHHMMSS();
                    $('.player__time-timer').text(currenttime);

                    //calculate percentage for css theming?
                    currentpct = Math.round((100/Number(totaltime)) * Number(currenttimeint)*100)/100;
                    $('.player__time-progress').css({'width':currentpct + '%'});
                }
            }, 500)
        }

        /**
         * Stop current player timer.
         */
        function stopWatch(){
            clearTimeout(watchId);
        }


        /**
         * Youtube player state has changed (pause / play / end)
         */
        function onPlayerStateChange(event) {
            switch (event.data){
                case 0:
                    skipToNextTrack();
                    break;
                case 1:
                    startWatch();
                    showNotification();
                    break;
                case 2:
                    stopWatch();
                    break;
            }
        }

        /**
         * Skip to next track if an error occures. (100, 101, 150).
         */
        function onPlayerError(event){
            switch(event.data){
                case 150:
                    skipToNextTrack();
                    break;
                case 100:
                    skipToNextTrack();
                    break;
                case 101:
                    skipToNextTrack();
                    break;
                default:
                    break;
            }
        }

        /**
         * Helper function to skip to the next track.
         */
        function skipToNextTrack(){
            done = true;
            stopWatch();
            $.ajax({
                url: '/ajax/set-done/' + $('.player__title').attr('data-video-id')
            }).done(function () {
                window.location = window.location;
            });
        }

        /**
         * Toggle muted stated of player
         */
        function muteToggle() {
            if (player.isMuted()) {
                player.unMute();
                $('.player__mute').removeClass('player--muted');
            } else {
                player.mute();
                $('.player__mute').addClass('player--muted');
            }
        }

        /**
         * Parse seconds to HH:MM:SS format
         *
         * @returns {string}
         */
        String.prototype.toHHMMSS = function () {
            var sec_num = parseInt(this, 10);
            var hours   = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);

            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        };

    </script>
{% endblock %}
</body>
</html>
