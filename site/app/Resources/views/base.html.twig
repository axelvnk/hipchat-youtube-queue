<!DOCTYPE html>
<html lang="en" ng-app="radiowiziApp">
<head>
    <title>{%  block title %}{% endblock %}Radio Wizi - Instant classics</title>
    <meta name="description" content="Radio Wizi.">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block stylesheets %}{% endblock %}
    <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}"/>

    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/main.min.css">

</head>
<body>
    <div class="page">
        <h1 class="header__logo"><a href="" class="ir">Radio Wizi</a></h1>
        <div ng-view></div>
        {#{% block body %}{% endblock %}#}
    </div>
{% block javascripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-resource.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>

    <script src="/js/src/app.js"></script>
    <script src="/js/src/controllers.js"></script>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="text/javascript">
        var player;
        var done = false;
        var currenttimeint = $('.player__title').data('video-skip');
        var currenttime = '00:00:00';
        var currentpct = 0;
        var totaltime = 0;
        var watchId;
        var notificationShown = false;

        $(document).ready(function() {
            var $timeDuration = $('.player__time-duration');
            totaltime = $timeDuration.text();
            $timeDuration.text($timeDuration.text().toHHMMSS());
            ajaxLoadPlaylist();
        });

        /**
         * Ajax function to load the upcoming movies
         */
        function ajaxLoadPlaylist() {
            $.ajax({
                url: '/ajax/load-videos'
            }).done(function (data) {
                $('#coming-up .playlist').html('');
                $.each(data, function (k, value) {
                    var listItem = '<li class="playlist__song">';
                    listItem += '<span class="song__title">';
                    listItem += value.title;
                    listItem += '</span></li>';

                    $('#coming-up .playlist').append(listItem);
                });
            });
        }

        /**
         * Youtube api is ready, create player
         */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                },
                playerVars: {
                    controls: 0,
                    disablekb: 1,
                    fs: 0,
                    iv_load_policy: 3,
                    modestbranding: 1,
                    rel: 0
                }
            });
        }

        /**
         * Start current player timer.
         */
        function startWatch(){
            watchId = setInterval( function(){
                if(typeof player.getCurrentTime === 'function' && !isNaN(player.getCurrentTime())) {
                    currenttimeint = Number(player.getCurrentTime());
                    currenttime = String(currenttimeint).toHHMMSS();
                    $('.player__time-timer').text(currenttime);

                    //calculate percentage for css theming?
                    currentpct = Math.round((100/Number(totaltime)) * Number(currenttimeint)*100)/100;
                    $('.player__time-progress').css({'width':currentpct + '%'});
                }
            }, 500)
        }

        /**
         * Stop current player timer.
         */
        function stopWatch(){
            clearTimeout(watchId);
        }

        /**
         * Load video by youtube key
         */
        function loadVideoId(videoKey) {
            player.loadVideoById({
                'videoId': videoKey,
                'startSeconds': $('.player__title').data('video-skip'),
                'suggestedQuality': 'large'
            });
            player.playVideo();
            $.ajax({
                url: '/ajax/start-playing/' + $('.player__title').attr('data-video-id')
            });
        }

        /**
         * Youtube player state has changed (pause / play / end)
         */
        function onPlayerStateChange(event) {
            switch (event.data){
                case 0:
                    skipToNextTrack();
                    break;
                case 1:
                    startWatch();
                    showNotification();
                    break;
                case 2:
                    stopWatch();
                    break;
            }
        }

        /**
         * Skip to next track if an error occures. (100, 101, 150).
         */
        function onPlayerError(event){
            switch(event.data){
                case 150:
                    skipToNextTrack();
                    break;
                case 100:
                    skipToNextTrack();
                    break;
                case 101:
                    skipToNextTrack();
                    break;
                default:
                    break;
            }
        }

        /**
         * Helper function to skip to the next track.
         */
        function skipToNextTrack(){
            done = true;
            stopWatch();
            $.ajax({
                url: '/ajax/set-done/' + $('.player__title').attr('data-video-id')
            }).done(function () {
                window.location = window.location;
            });
        }

        /**
         * Toggle muted stated of player
         */
        function muteToggle() {
            if (player.isMuted()) {
                player.unMute();
                $('.player__mute').removeClass('player--muted');
            } else {
                player.mute();
                $('.player__mute').addClass('player--muted');
            }
        }

        /**
         * Parse seconds to HH:MM:SS format
         *
         * @returns {string}
         */
        String.prototype.toHHMMSS = function () {
            var sec_num = parseInt(this, 10);
            var hours   = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);

            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        };

        /**
         * On youtube player ready
         * @param event
         */
        function onPlayerReady(event) {
            loadVideoId($('.player__title').attr('data-youtube-id'));
        }

        function showNotification(){
            if ('Notification' in window) {
                Notification.requestPermission(function() {
                    if(!getNotificationShown()){
                        var notification = new Notification('Radio Wizi - Now playing', {
                            body: player.getVideoData().title + '\nRequested by ' + $('.player__requester-name').html(),
                            icon: 'http://img.youtube.com/vi/' + player.getVideoData().video_id + '/default.jpg'
                        });

                        setNotificationShown(true);

                        setTimeout(function(){
                            notification.close();
                        }, 5000);
                    }
                });
            }
        }

        function getNotificationShown(){
            return notificationShown;
        }

        function setNotificationShown(value){
            if(typeof value == 'boolean'){
                notificationShown = value;
            }

            return notificationShown;
        }
    </script>
{% endblock %}
</body>
</html>
